#include "client.h"
#include <netinet/in.h>
/*****************************************************************
?????¡ã?¤ã?????	: client_command.c
æ©????		: ????????¤ã?¢ã?³ã???????³ã????³ã????????
*****************************************************************/
static void SetIntData2DataBlock(void *data,int intData,int *dataSize);
static void SetCharData2DataBlock(void *data,char charData,int *dataSize);

bool isRanking = false; //?????³ã?­ã?³ã?°ã????¼ã?¿ã????????????????????true
/*****************************************************************
??¢æ?°å??	: ExecuteCommand
æ©????	: ??µã?¼ã????¼ã?????????????????????????³ã????³ã???????????ï¼?
		  å¼??????°ã?????ä¿¡ã??ï¼?å®?è¡???????
å¼????	: char	command		: ??³ã????³ã??
??ºå??	: ?????­ã?°ã?????çµ?äº???³ã????³ã???????????????????????????????????0???è¿????ï¼?
		  ??????ä»¥å?????1???è¿????
*****************************************************************/
int ExecuteCommand(char command)
{
    int	endFlag = 1;

    switch(command){
        case PLAYERDATA_COMMAND:{
            Player *p = (Player*)malloc(sizeof(Player)*gClientNum);
            RecvData(p,sizeof(Player)*gClientNum);
            //??¼ç??????????????
            for(int i = 0; i <gClientNum;i++)
            {
                if(i != clientID)
                    player[i] = p[i];
            }
            firstRecvPlayerInfo = true;
            free(p);
        }
            break;
		
        case BULLETDATA_COMMAND:{
            BULLET b;
            RecvData(&b, sizeof(BULLET));
            array_bullet.push_back(BULLET(b));
            bullet_Num++;   
        }
        break;
        case RANKING_DATA:
            {
                // ????????¤ã?¤ã?¼ã???????°æ?????
                Player *p = (Player*)malloc(sizeof(Player)*gClientNum);
                RecvData(p,sizeof(Player)*gClientNum);
                //??¼ç??????????????
                for(int i = 0; i <gClientNum;i++)
                {
                    player[i] = p[i];
                }
                free(p);

                RankingData data;
                for(int i=0; i<gClientNum; i++){
                    sprintf(data.clientName[i],"%s",game.clientName[i]);
                    data.score[i] = player[i].score;
                    data.kill_player[i] = player[i].kill_player;
                    data.death[i] = player[i].death;
                    data.kill_enemy[i] = player[i].kill_enemy;
                    data.kill_boss[i] = player[i].kill_boss;
                }

                //??²ã?¼ã??????????¶ã????????????????¿ã?????
                WriteRankingFile(gClientNum,&data);
                isRanking = true;
                SendEndCommand();
                endFlag = 0;
            }
            break;
        case SCOREBALL_COMMAND:
            {
                ScoreBall s;
                RecvData(&s, sizeof(ScoreBall));
                ary_scoreBall.push_back(ScoreBall(s));
                scoreBallNum++;
                printf("scoreBall Data was recieved.\n");
            }
            break;
        case TIMER_COMMAND:
            RecvData(&game.time, sizeof(unsigned int));
            break;
        case PLAYERINFO_COMMAND:
            RecvData(&player[clientID],sizeof(Player));
            break;
        case END_COMMAND:
            if(isRanking){
                endFlag = 0;
                printf("move ranking.\n");
            }
            else{
                endFlag = -1;
                printf("END selected.\n");
            }
			break;
        default:
            break;
    }

    return endFlag;
}

/*****************************************************************
??¢æ?°å??	: SendEndCommand
æ©????	: ?????­ã?°ã????????çµ?äº??????¥ã?????????????????ï¼?
		  ??µã?¼ã????¼ã???????¼ã?¿ã????????
å¼????	: ??????
??ºå??	: ??????
*****************************************************************/
void SendEndCommand(void)
{
    unsigned char	data[MAX_DATA];
    int			dataSize;

    dataSize = 0;
    /* ??³ã????³ã???????»ã????? */
    SetCharData2DataBlock(data,END_COMMAND,&dataSize);

    /* ?????¼ã?¿ã?????ä¿? */
    SendData(data,dataSize);
}

void SendPlayerDataCommand(void){

    unsigned char	data[MAX_DATA];
    int			dataSize;

    dataSize = 0;
    /* ??³ã????³ã???????»ã????? */
    SetCharData2DataBlock(data,PLAYERDATA_COMMAND,&dataSize);
    /* ?????¼ã?¿ã?????ä¿? */
    SendData(data,dataSize);

    //playerData??????ä¿?

    SendData(&(player[clientID]),sizeof(Player));

}

void SendBulletDataCommand(int num){

    char com = BULLETDATA_COMMAND;

    /* ?????¼ã?¿ã?????ä¿? */
    SendData(&com,sizeof(char));

    //clientData??????ä¿?
    SendData(&array_bullet[num],sizeof(BULLET));

}

void SendScoreBallDataCommand(void){
    char com = SCOREBALL_COMMAND;

    /* ?????¼ã?¿ã?????ä¿? */
    SendData(&com,sizeof(char));

    //ScoreBallData??????ä¿?
    
    SendData(&ary_scoreBall[scoreBallNum-1],sizeof(ScoreBall));
}


// mode 0:kill_player num
void SendPlayerInfoData(int clientIndex, int mode,int num){
    char com = PLAYERINFO_COMMAND;
    /* ?????¼ã?¿ã?????ä¿? */
    SendData(&com,sizeof(char));

    num=1;//not send

    //Data??????ä¿?
    SendData(&mode, sizeof(int));
    SendData(&clientIndex,sizeof(int));

}

/*****
static
*****/
/*****************************************************************
??¢æ?°å??	: SetIntData2DataBlock
æ©????	: int ???????????¼ã?¿ã?????ä¿¡ç???????¼ã?¿ã?????å¾??????»ã???????????
å¼????	: void		*data		: ???ä¿¡ç???????¼ã??
		  int		intData		: ??»ã????????????????¼ã??
		  int		*dataSize	: ???ä¿¡ç???????¼ã?¿ã???¾å???????µã?¤ã??
??ºå??	: ??????
*****************************************************************/
static void SetIntData2DataBlock(void *data,int intData,int *dataSize)
{
    int tmp;

    /* å¼??????°ã????§ã????? */
    assert(data!=NULL);
    assert(0<=(*dataSize));

    tmp = htonl(intData);

    /* int ???????????¼ã?¿ã?????ä¿¡ç???????¼ã?¿ã?????å¾??????³ã????¼ã????? */
    memcpy(data + (*dataSize),&tmp,sizeof(int));
    /* ?????¼ã?¿ã?µã?¤ã?ºã??å¢??????? */
    (*dataSize) += sizeof(int);
}

/*****************************************************************
??¢æ?°å??	: SetCharData2DataBlock
æ©????	: char ???????????¼ã?¿ã?????ä¿¡ç???????¼ã?¿ã?????å¾??????»ã???????????
å¼????	: void		*data		: ???ä¿¡ç???????¼ã??
		  int		intData		: ??»ã????????????????¼ã??
		  int		*dataSize	: ???ä¿¡ç???????¼ã?¿ã???¾å???????µã?¤ã??
??ºå??	: ??????
*****************************************************************/
static void SetCharData2DataBlock(void *data,char charData,int *dataSize)
{
    /* å¼??????°ã????§ã????? */
    assert(data!=NULL);
    assert(0<=(*dataSize));

    /* char ???????????¼ã?¿ã?????ä¿¡ç???????¼ã?¿ã?????å¾??????³ã????¼ã????? */
    *(char *)(data + (*dataSize)) = charData;
    /* ?????¼ã?¿ã?µã?¤ã?ºã??å¢??????? */
    (*dataSize) += sizeof(char);
}

