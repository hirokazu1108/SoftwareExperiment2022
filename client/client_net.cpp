#include "client.h"
#include<sys/socket.h>
#include<netdb.h>

#define	BUF_SIZE	100

static int	gSocket;	/* ??½ã?±ã????? */
static fd_set	gMask;	/* select()???????????¹ã?? */
static int	gWidth;		/* gMaskä¸­ã??????????§ã??????????¹ã?????????????? */

static void GetAllName(int *clientID,int *num,char clientNames[][NAME_MAX_LENGTH+1]);
static void SetMask(void);


/*****************************************************************
??¢æ?°å??	: SetUpClient
æ©????	: ??µã?¼ã????¼ã???????³ã???????·ã?§ã?³ã??è¨­ç?????ï¼?
		  ?????¼ã?¶ã?¼ã?????????????????ä¿¡ã??è¡????
å¼????	: char	*hostName		: ?????¹ã??
      u_short :?????¼ã????????
		  int	*num			: ???????????¤ã?¢ã?³ã?????
		  char	clientNames[][]		: ???????????¤ã?¢ã?³ã??????????¼ã?¶ã?¼å??
??ºå??	: ??³ã???????·ã?§ã?³ã??å¤±æ???????????-1,???????????????0
*****************************************************************/
int SetUpClient(char *hostName,u_short port,int *clientID,int *num,char clientNames[][NAME_MAX_LENGTH+1])
{
    struct hostent	*servHost;
    struct sockaddr_in	server;
    int			len;
    SaveData data;

    /* ?????¹ã????????????????¹ã???????±ã??å¾???? */
    if((servHost = gethostbyname(hostName))==NULL){
		fprintf(stderr,"Unknown host\n");
		return -1;int SetUpServer(int num);int SetUpServer(int num);
    }

    bzero((char*)&server,sizeof(server));
    server.sin_family = AF_INET;
    server.sin_port = htons(port);
    bcopy(servHost->h_addr,(char*)&server.sin_addr,servHost->h_length);

    /* ??½ã?±ã????????ä½?????????? */
    if((gSocket = socket(AF_INET,SOCK_STREAM,0)) < 0){
		fprintf(stderr,"socket allocation failed\n");
		return -1;
    }

    /* ??µã?¼ã????¼ã???Ž¥ç¶??????? */
    if(connect(gSocket,(struct sockaddr*)&server,sizeof(server)) == -1){
		fprintf(stderr,"cannot connect\n");
		close(gSocket);
		return -1;
    }
    fprintf(stderr,"connected\n");

    /* ??²ã?¼ã???????¼ã?¿ã??èª­ã?¿è¾¼?????§å????????èª­ã?¿å????? */
    ReadDataFile(&data);
    SendData(data.clientName,sizeof(char)*(NAME_MAX_LENGTH+1));

    printf("Please Wait\n");

    /* ???????????¤ã?¢ã?³ã??????????¼ã?¶ã?¼å?????å¾???? */
    GetAllName(clientID,num,clientNames);


    /* select()?????????????????¹ã????¤ã??è¨­å???????? */
    SetMask();
	
    WriteMatchFile(1);//1?????¸ã??è¾¼ã??????????????å®?äº?

    return 0;
}

/*****************************************************************
??¢æ?°å??	: SendRecvManager
æ©????	: ??µã?¼ã????¼ã????????????????????????????¼ã?¿ã??????????????
å¼????	: ??????
??ºå??	: ?????­ã?°ã?????çµ?äº???³ã????³ã??????????????????????????0???è¿????ï¼?
		  ??????ä»¥å?????1???è¿????
*****************************************************************/
int SendRecvManager(void)
{
    fd_set	readOK;
    char	command;
    int		i;
    int		endFlag = 1;
    struct timeval	timeout;

    /* select()???å¾???¡æ????????è¨­å???????? */
    timeout.tv_sec = 0;
    timeout.tv_usec = 20;

    readOK = gMask;
    /* ??µã?¼ã????¼ã??????????¼ã?¿ã??å±????????????????èª¿ã?¹ã?? */
    select(gWidth,&readOK,NULL,NULL,&timeout);
    if(FD_ISSET(gSocket,&readOK)){
		/* ??µã?¼ã????¼ã??????????¼ã?¿ã??å±????????????? */
    	/* ??³ã????³ã?????èª­ã?¿è¾¼??? */
		RecvData(&command,sizeof(char));
    	/* ??³ã????³ã?????å¯¾ã??????????????è¡???? */
		endFlag = ExecuteCommand(command);
    }
    return endFlag;
}

/*****************************************************************
??¢æ?°å??	: RecvIntData
æ©????	: ??µã?¼ã????¼ã?????int???????????¼ã?¿ã??????????????
å¼????	: int		*intData	: ???ä¿¡ã??????????¼ã??
??ºå??	: ???????????£ã???????¤ã?????
*****************************************************************/
int RecvIntData(int *intData)
{
    int n,tmp;
    
    /* å¼??????°ã????§ã????? */
    assert(intData!=NULL);

    n = RecvData(&tmp,sizeof(int));
    (*intData) = ntohl(tmp);
    
    return n;
}

/*****************************************************************
??¢æ?°å??	: SendData
æ©????	: ??µã?¼ã????¼ã???????¼ã?¿ã????????
å¼????	: void		*data		: ???????????¼ã??
		  int		dataSize	: ???????????¼ã?¿ã????µã?¤ã??
??ºå??	: ??????
*****************************************************************/
void SendData(void *data,int dataSize)
{
    /* å¼??????°ã????§ã????? */
    assert(data != NULL);
    assert(0 < dataSize);

    write(gSocket,data,dataSize);
}

/*****************************************************************
??¢æ?°å??	: CloseSoc
æ©????	: ??µã?¼ã????¼ã???????³ã???????·ã?§ã?³ã???????­ã?????
å¼????	: ??????
??ºå??	: ??????
*****************************************************************/
void CloseSoc(void)
{
    printf("...Connection closed\n");
    close(gSocket);
}

/*****
static
*****/
/*****************************************************************
??¢æ?°å??	: GetAllName
æ©????	: ??µã?¼ã????¼ã????????????????¤ã?¢ã?³ã??????????¼ã?¶ã?¼å????????ä¿¡ã?????
å¼????	: int		*num			: ????????¤ã?¢ã?³ã?????
		  char		clientNames[][]	: ???????????¤ã?¢ã?³ã??????????¼ã?¶ã?¼å??
??ºå??	: ??????
*****************************************************************/
static void GetAllName(int *clientID,int *num,char clientNames[][NAME_MAX_LENGTH+1])
{
    int	i;

    /* ????????¤ã?¢ã?³ã??????·ã??èª­ã?¿è¾¼??? */
    RecvIntData(clientID);
    /* ????????¤ã?¢ã?³ã????°ã??èª­ã?¿è¾¼??? */
    RecvIntData(num);

    /* ???????????¤ã?¢ã?³ã??????????¼ã?¶ã?¼å?????èª­ã?¿è¾¼??? */
    for(i=0;i<(*num);i++){
		  RecvData(clientNames[i],sizeof(char)*(NAME_MAX_LENGTH+1));
    }
#ifndef NDEBUG
    printf("#####\n");
    printf("client number = %d\n",(*num));
    for(i=0;i<(*num);i++){
		printf("%d:%s\n",i,clientNames[i]);
    }
#endif
}

/*****************************************************************
??¢æ?°å??	: SetMask
æ©????	: select()?????????????????¹ã????¤ã??è¨­å????????
å¼????	: ??????
??ºå??	: ??????
*****************************************************************/
static void SetMask(void)
{
    int	i;

    FD_ZERO(&gMask);
    FD_SET(gSocket,&gMask);

    gWidth = gSocket+1;
}

/*****************************************************************
??¢æ?°å??	: RecvData
æ©????	: ??µã?¼ã????¼ã??????????¼ã?¿ã??????????????
å¼????	: void		*data		: ???ä¿¡ã??????????¼ã??
		  int		dataSize	: ???ä¿¡ã??????????¼ã?¿ã????µã?¤ã??
??ºå??	: ???????????£ã???????¤ã?????
*****************************************************************/
int RecvData(void *data,int dataSize)
{
    /* å¼??????°ã????§ã????? */
    assert(data != NULL);
    assert(0 < dataSize);

    return read(gSocket,data,dataSize);
}
